' reps (Semaine ' + lastPerf.week + ')' +
'</div>';
} else {
perfMsg = '<div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);color:var(--accent);padding:12px 16px;border-radius:10px;margin-bottom:16px;font-size:14px;font-weight:600">' +
'‚≠ê Premi√®re fois pour cet exercice !' +
'</div>';
}

let setsHtml = '';
for (let i = 1; i <= ex.sets; i++) {
setsHtml += '<div class="set-row">' +
'<div class="set-label">S√©rie ' + i + '</div>' +
'<div>' +
'<label class="input-label">KG</label>' +
'<input type="number" value="' + w + '" class="set-input w-' + exId + '-' + i + '" step="0.5" placeholder="Poids">' +
'</div>' +
'<div>' +
'<label class="input-label">REPS</label>' +
'<input type="number" value="' + ex.reps + '" class="set-input r-' + exId + '-' + i + '" placeholder="Reps">' +
'</div>' +
'<div>' +
'<input type="checkbox" id="s-' + i + '-' + exId + '" class="set-checkbox">' +
'<label for="s-' + i + '-' + exId + '"></label>' +
'</div>' +
'</div>';
}

details.innerHTML = '<div class="technique-banner">‚ú® ' + techBanner + '</div>' +
perfMsg +
setsHtml +
'<div class="exercise-actions">' +
'<button class="btn-secondary" onclick="modifyWeight(\'' + ex.name + '\')">‚úèÔ∏è Modifier Poids</button>' +
'<button class="btn-save" onclick="savePerf(\'' + ex.name + '\')">üíæ Enregistrer & Valider</button>' +
'</div>';

document.querySelectorAll('#details-' + exId + ' .set-checkbox').forEach(function(cb, idx) {
cb.addEventListener('change', function() {
if (this.checked) {
const isLast = idx === ex.sets - 1;
const nextText = isLast ? "Prochain exercice" : "Repos";
startTimer(ex.rest, nextText);
}
});
});
}

function startTimer(duration, next) {
clearInterval(timerInterval);
const timer = document.getElementById('restTimer');
const text = document.getElementById('timerText');
const circle = document.getElementById('timerProgressCircle');
const nextExerciseName = document.getElementById('nextExerciseName');
if (!timer || !text || !circle || !nextExerciseName) return;
nextExerciseName.textContent = next;
timer.classList.add('visible');
let left = duration;
const circ = 226;
const update = function() {
const minutes = Math.floor(left/60);
const seconds = (left%60).toString().padStart(2,'0');
text.textContent = minutes + ':' + seconds;
circle.style.strokeDashoffset = circ - (left/duration)*circ;
if (left <= 0) {
clearInterval(timerInterval);
timer.classList.remove('visible');
if (navigator.vibrate) {
navigator.vibrate([400, 200, 400, 200, 400]);
}
playBeep();
} else {
left--;
}
};
update();
timerInterval = setInterval(update, 1000);
}

function playBeep() {
try {
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
const oscillator = audioContext.createOscillator();
const gainNode = audioContext.createGain();
oscillator.connect(gainNode);
gainNode.connect(audioContext.destination);
oscillator.frequency.value = 800;
oscillator.type = 'sine';
gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
oscillator.start(audioContext.currentTime);
oscillator.stop(audioContext.currentTime + 0.5);
} catch(e) {
console.log('Audio non support√©');
}
}

const skipTimerBtn = document.getElementById('skipTimerBtn');
if (skipTimerBtn) {
skipTimerBtn.addEventListener('click', function() {
clearInterval(timerInterval);
const timer = document.getElementById('restTimer');
if (timer) timer.classList.remove('visible');
});
}

window.modifyWeight = function(exName) {
const w = state.weights[exName];
openModal('<h3 style="font-weight:700;font-size:20px;margin-bottom:16px;color:var(--accent)">‚úèÔ∏è Modifier le poids</h3>' +
'<div style="text-align:center;margin-bottom:16px;color:var(--text-secondary);font-size:16px">' + exName + '</div>' +
'<input type="number" id="newW" class="set-input" value="' + w + '" step="0.5" style="width:100%;font-size:24px;margin-bottom:20px;padding:18px"/>' +
'<div style="display:flex;gap:12px">' +
'<button class="btn-save" onclick="saveWeight(\'' + exName + '\')" style="flex:1;padding:16px">üíæ Enregistrer</button>' +
'<button class="btn-secondary" onclick="closeModal()" style="flex:1;padding:16px">‚ùå Annuler</button>' +
'</div>');
setTimeout(function() {
const input = document.getElementById('newW');
if (input) {
input.focus();
input.select();
}
}, 100);
};

window.saveWeight = function(exName) {
const newWInput = document.getElementById('newW');
if (!newWInput) return;
const nw = parseFloat(newWInput.value);
if (!isNaN(nw) && nw >= 0) {
const oldWeight = state.weights[exName];
state.weights[exName] = nw;
saveState();
showQuickMsg('‚úì ' + exName + ': ' + oldWeight + 'kg ‚Üí ' + nw + 'kg');
closeModal();
setTimeout(function() { openSession(currentSessionKey); }, 300);
} else {
showQuickMsg('‚ö†Ô∏è Poids invalide');
}
};

window.savePerf = function(exName) {
const exId = exName.replace(/[^a-zA-Z0-9]/g, '');
const ex = state.program[currentSessionKey].exercises.find(function(e) { return e.name === exName; });
if (!ex) return;
let sets = [];
for (let i = 1; i <= ex.sets; i++) {
const wInput = document.querySelector('.w-' + exId + '-' + i);
const rInput = document.querySelector('.r-' + exId + '-' + i);
if (!wInput || !rInput) continue;
const w = parseFloat(wInput.value) || 0;
const r = parseInt(rInput.value) || 0;
if (r > 0) sets.push({ w: w, r: r });
}
if (sets.length === 0) {
return showQuickMsg("‚ö†Ô∏è Entrez au moins une r√©p√©tition");
}
const best = sets.reduce(function(a,b) { return b.r > a.r ? b : a; });
if (!state.hist[exName]) state.hist[exName] = [];
state.hist[exName].push({
week: state.week,
weight: best.w,
reps: best.r,
ts: Date.now(),
allSets: sets
});
state.weights[exName] = best.w;
saveState();
showQuickMsg('‚úÖ ' + exName + ': ' + sets.length + ' s√©rie(s) ‚Ä¢ ' + best.r + ' reps @ ' + best.w + 'kg');
};

function openModal(html) {
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
if (!modal || !modalContent) return;
modal.classList.add('active');
modalContent.innerHTML = html;
}

window.closeModal = function() {
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
if (!modal || !modalContent) return;
modal.classList.remove('active');
modalContent.innerHTML = '';
};

window.createCustomExercise = function() {
openModal('<h3 style="font-weight:700;font-size:20px;margin-bottom:20px;color:var(--accent)">‚ûï Nouvel Exercice</h3>' +
'<div style="display:flex;flex-direction:column;gap:16px">' +
'<div>' +
'<label class="input-label">Nom de l\'exercice</label>' +
'<input type="text" id="customExName" class="set-input" placeholder="Ex: Squat Bulgare" style="width:100%;padding:14px"/>' +
'</div>' +
'<div>' +
'<label class="input-label">Type</label>' +
'<select id="customExType" class="set-input" style="width:100%;padding:14px">' +
'<option value="halt√®res">Halt√®res</option>' +
'<option value="barre">Barre</option>' +
'<option value="machine">Machine</option>' +
'<option value="poids du corps">Poids du corps</option>' +
'</select>' +
'</div>' +
'<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
'<div>' +
'<label class="input-label">S√©ries</label>' +
'<input type="number" id="customExSets" class="set-input" value="3" min="1" style="width:100%;padding:14px"/>' +
'</div>' +
'<div>' +
'<label class="input-label">Reps</label>' +
'<input type="text" id="customExReps" class="set-input" value="10" placeholder="Ex: 8-12" style="width:100%;padding:14px"/>' +
'</div>' +
'</div>' +
'<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
'<div>' +
'<label class="input-label">Repos (sec)</label>' +
'<input type="number" id="customExRest" class="set-input" value="90" min="0" style="width:100%;padding:14px"/>' +
'</div>' +
'<div>' +
'<label class="input-label">Poids (kg)</label>' +
'<input type="number" id="customExWeight" class="set-input" value="20" step="0.5" min="0" style="width:100%;padding:14px"/>' +
'</div>' +
'</div>' +
'</div>' +
'<div style="display:flex;gap:12px;margin-top:24px">' +
'<button class="btn-save" onclick="saveCustomExercise()" style="flex:1;padding:16px">üíæ Cr√©er</button>' +
'<button class="btn-secondary" onclick="closeModal()" style="flex:1;padding:16px">‚ùå Annuler</button>' +
'</div>');
};

window.saveCustomExercise = function() {
const nameInput = document.getElementById('customExName');
const typeInput = document.getElementById('customExType');
const setsInput = document.getElementById('customExSets');
const repsInput = document.getElementById('customExReps');
const restInput = document.getElementById('customExRest');
const weightInput = document.getElementById('customExWeight');
if (!nameInput || !typeInput || !setsInput || !repsInput || !restInput || !weightInput) return;
const name = nameInput.value.trim();
const type = typeInput.value;
const sets = parseInt(setsInput.value);
const reps = repsInput.value.trim();
const rest = parseInt(restInput.value);
const weight = parseFloat(weightInput.value);
if (!name) {
alert('‚ö†Ô∏è Nom requis');
return;
}
const newEx = {
name: name,
type: type,
sets: sets,
reps: reps,
rest: rest,
weight: weight,
tech: 'Standard',
custom: true
};
state.customExercises.push(newEx);
state.weights[name] = weight;
saveState();
showQuickMsg('‚úÖ Exercice "' + name + '" cr√©√© !');
closeModal();
};

window.viewCustomExercises = function() {
let html = '<h3 style="font-weight:700;margin-bottom:20px;color:var(--accent);font-size:20px">üí™ Mes Exercices</h3>';
if (state.customExercises.length === 0) {
html += '<div style="text-align:center;color:var(--text-secondary);padding:20px">Aucun exercice personnalis√©</div>';
} else {
html += '<div style="display:flex;flex-direction:column;gap:10px">';
state.customExercises.forEach(function(ex) {
html += '<div style="padding:14px;background:var(--bg-card-light);border-radius:10px;border:1px solid var(--border)">' +
'<div style="font-weight:700;margin-bottom:4px">' + ex.name + '</div>' +
'<div style="font-size:13px;color:var(--text-secondary)">' + ex.sets + '√ó' + ex.reps + ' ‚Ä¢ ' + ex.rest + 's ‚Ä¢ ' + ex.weight + 'kg ‚Ä¢ ' + ex.type + '</div>' +
'</div>';
});
html += '</div>';
}
html += '<button class="btn-save" onclick="createCustomExercise()" style="margin-top:20px;width:100%;padding:16px">‚ûï Nouvel Exercice</button>';
html += '<button class="btn-secondary" onclick="closeModal()" style="margin-top:12px;width:100%;padding:16px">Fermer</button>';
openModal(html);
};

const openStatsBtn = document.getElementById('openStats');
if (openStatsBtn) {
openStatsBtn.addEventListener('click', function() {
let h = '<h3 style="font-weight:700;margin-bottom:20px;color:var(--accent);font-size:20px">üìä Poids Actuels</h3><div style="display:flex;flex-direction:column;gap:10px">';
Object.entries(state.weights).forEach(function(entry) {
const n = entry[0];
const w = entry[1];
h += '<div style="display:flex;justify-content:space-between;padding:14px;background:var(--bg-card-light);border-radius:10px;border:1px solid var(--border);font-size:15px"><span>' + n + '</span><strong style="color:var(--accent)">' + w + 'kg</strong></div>';
});
h += '</div>';
h += '<button class="btn-secondary" onclick="viewCustomExercises()" style="margin-top:16px;width:100%;padding:16px">üí™ Mes Exercices</button>';
h += '<button class="btn-save" onclick="closeModal()" style="margin-top:12px;width:100%;padding:16px">Fermer</button>';
openModal(h);
});
}

const exportWeightsBtn = document.getElementById('exportWeights');
if (exportWeightsBtn) {
exportWeightsBtn.addEventListener('click', function() {
let csv = 'Exercise,Week,Set,Reps,Weight(kg),Date\n';
Object.entries(state.hist).forEach(function(entry) {
const exName = entry[0];
const records = entry[1];
records.forEach(function(r) {
const date = new Date(r.ts).toLocaleDateString('fr-FR');
if (r.allSets && r.allSets.length > 0) {
r.allSets.forEach(function(set, idx) {
csv += '"' + exName + '",' + r.week + ',' + (idx + 1) + ',' + set.r + ',' + set.w + ',' + date + '\n';
});
} else {
csv += '"' + exName + '",' + r.week + ',1,' + r.reps + ',' + r.weight + ',' + date + '\n';
}
});
});
const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
const dateStr = new Date().toISOString().split('T')[0];
a.download = 'hybrid_master_51_COMPLET_' + dateStr + '.csv';
a.click();
showQuickMsg('‚úì Export complet r√©ussi !');
});
}

const resetAppBtn = document.getElementById('resetApp');
if (resetAppBtn) {
resetAppBtn.addEventListener('click', function() {
if (confirm('‚ö†Ô∏è R√©initialiser toutes les donn√©es ? Cette action est irr√©versible.')) {
try {
localStorage.removeItem(STATE_KEY);
location.reload();
} catch(e) {
console.error('Erreur reset:', e);
}
}
});
}

const advanceWeekBtn = document.getElementById('advanceWeek');
if (advanceWeekBtn) {
advanceWeekBtn.addEventListener('click', function() {
if (state.week < 26) {
state.week++;
saveState();
renderHeader();
showQuickMsg('‚úì Semaine ' + state.week);
} else {
showQuickMsg('üéâ Programme termin√© !');
}
});
}

const prevWeekBtn = document.getElementById('prevWeek');
if (prevWeekBtn) {
prevWeekBtn.addEventListener('click', function() {
if (state.week > 1) {
state.week--;
saveState();
renderHeader();
showQuickMsg('‚úì Semaine ' + state.week);
}
});
}

const backHomeBtn = document.getElementById('backHomeBtn');
if (backHomeBtn) {
backHomeBtn.addEventListener('click', window.backHome);
}

const modalOverlay = document.querySelector('.modal-overlay');
if (modalOverlay) {
modalOverlay.addEventListener('click', window.closeModal);
}

state = loadState();
renderHeader();
renderProgramList();
})();
</script>
</body>
</html>
